<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proje Y√∂netimi</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- TASARIM DEƒûƒ∞≈ûKENLERƒ∞ --- */
        :root {
            --bg-body: #0a0e17;
            --bg-gradient: linear-gradient(135deg, #0a0e17 0%, #1a2238 100%);
            --glass-bg: rgba(255, 215, 0, 0.03);
            --glass-border: rgba(255, 215, 0, 0.15);
            --glass-blur: blur(15px);
            --primary: #FFD700; --secondary: #FF6B6B; --success: #00d26a; --warning: #ff9f43; --danger: #ee5253; --info: #00d2ff;
            --text-main: #ffffff; --text-muted: #94a3b8;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Sora', sans-serif; }
        body { background: var(--bg-gradient); background-attachment: fixed; color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; overflow-x: hidden; padding: 20px; }
        .app-container { width: 100%; max-width: 1200px; margin: 0 auto; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-top: 20px; }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: #000; padding: 12px 30px; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .btn-primary:hover { transform: translateY(-2px); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 50px; }
        .glass-card { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); border-radius: 24px; padding: 25px; box-shadow: var(--card-shadow); transition: 0.3s; position: relative; }
        .glass-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .clickable-card { cursor: pointer; }
        .stat-icon { font-size: 2rem; margin-bottom: 15px; color: var(--primary); background: rgba(255,255,255,0.05); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 14px; }
        .stat-number { font-size: 2.2rem; font-weight: 700; color: #fff; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: var(--text-muted); }

        .projects-wrapper { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
        .project-card { background: var(--glass-bg); backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); border-radius: 24px; padding: 25px; transition: 0.3s; display: flex; flex-direction: column; gap: 15px; box-shadow: var(--card-shadow); }
        .project-card:hover { border-color: var(--secondary); }
        .p-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .p-title { font-size: 1.3rem; font-weight: 600; color: white; margin-bottom: 5px; }
        .status-badge { padding: 6px 14px; border-radius: 30px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .status-active { background: rgba(255, 159, 67, 0.15); color: var(--warning); border: 1px solid var(--warning); }
        .status-done { background: rgba(0, 210, 106, 0.15); color: var(--success); border: 1px solid var(--success); }
        .tech-pill { font-size: 0.75rem; padding: 4px 12px; background: rgba(255,255,255,0.05); border-radius: 12px; color: var(--text-muted); border: 1px solid var(--glass-border); }
        
        .card-progress-container { margin-top: 5px; margin-bottom: 5px; }
        .card-progress-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .card-progress-fill { height: 100%; background: var(--info); transition: width 0.5s ease; border-radius: 3px; }
        .card-progress-text { font-size: 0.8rem; color: var(--info); display: flex; justify-content: space-between; margin-bottom: 2px; }
        
        .duration-info { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); }
        .duration-actual { color: rgba(255,255,255,0.6); font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
        .duration-estimated { font-size: 0.75rem; opacity: 0.7; }
        
        .p-finance { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; font-size: 0.95rem; cursor: pointer; transition: 0.2s; border: 1px dashed transparent; }
        .p-finance:hover { border-color: var(--primary); background: rgba(0,0,0,0.4); }
        .p-finance-disabled { opacity: 0.5; cursor: not-allowed; text-decoration: line-through; pointer-events: none; }

        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 100; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-bg.open { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        .modal-card { background: linear-gradient(135deg, var(--bg-body), #1a1a2e); border: 1px solid var(--glass-border); width: 100%; max-width: 600px; border-radius: 24px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); max-height: 90vh; overflow-y: auto; }
        
        input, select { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 14px; border-radius: 12px; color: white; margin-top: 8px; margin-bottom: 20px; transition: 0.3s; font-family: inherit; }
        select option { background-color: #1a1a2e; color: white; }
        input:focus, select:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); outline: none; }
        label { color: var(--text-muted); font-size: 0.9rem; font-weight: 600; margin-left: 5px; }
        .finance-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .finance-table th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--glass-border); }
        .finance-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); color: white; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; background: rgba(255,255,255,0.1); border:none; color: white; border-radius: 8px; cursor: pointer; }
        
        #loading { text-align: center; font-size: 1.2rem; color: var(--primary); margin-top: 50px; display: none; }
    </style>
</head>
<body>

<div class="modal-bg" id="projectModal">
    <div class="modal-card">
        <h2 style="margin-bottom: 20px; color: var(--primary);">‚ú® Yeni Proje Olu≈ütur</h2>
        <form id="projectForm">
            <label>Proje ƒ∞smi</label>
            <input type="text" id="pName" placeholder="√ñrn: Mobil Oyun" required>
            
            <label>Teknolojiler</label>
            <input type="text" id="pTech" placeholder="Unity, C#, Blender">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label>Ba≈ülangƒ±√ß Tarihi</label>
                    <div class="flex-row" style="margin-top: 8px;">
                        <input type="date" id="pStartDate" required>
                        <button type="button" class="btn-small" onclick="window.setToday('pStartDate')" style="background: var(--primary); color:black; font-weight:bold;">Bug√ºn</button>
                    </div>
                </div>
                <div><label>Tahmini Biti≈ü</label><input type="date" id="pEndDate" style="margin-top:8px;" required></div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Ger√ßek Biti≈ü Tarihi (Opsiyonel)</label>
                <div class="flex-row" style="margin-top: 8px;">
                    <input type="date" id="pRealDate">
                    <button type="button" class="btn-small" onclick="window.setToday('pRealDate')" style="background: rgba(255,255,255,0.1);">Bug√ºn</button>
                </div>
            </div>

            <div style="margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="pNoProfit" style="width: 20px; height: 20px; margin:0;">
                <label for="pNoProfit" style="margin:0; cursor: pointer; color: white;">Bu projeden maddi bir beklentim yok / Hobi Projesi</label>
            </div>

            <label>Yapƒ±lacaklar Listesi</label>
            <div id="todoInputs" style="margin-bottom: 15px;"></div>
            <button type="button" onclick="window.addTodoInput()" style="background:rgba(255,255,255,0.05); border:1px dashed var(--glass-border); color:var(--text-muted); width:100%; padding:12px; border-radius:12px; cursor:pointer;">+ ƒ∞≈ü Ekle</button>

            <div style="margin-top: 30px; display:flex; gap:15px; justify-content: flex-end;">
                <button type="button" onclick="window.closeModal('projectModal')" style="background:transparent; border:none; color:var(--text-muted); cursor:pointer;">ƒ∞ptal</button>
                <button type="submit" class="btn-primary" style="padding: 12px 30px;"><span>Kaydet</span></button>
            </div>
        </form>
    </div>
</div>

<div class="modal-bg" id="financeModal">
    <div class="modal-card">
        <h2 id="finModalTitle" style="margin-bottom: 20px; color: var(--success);">üí∞ Finans Y√∂netimi</h2>
        <div id="financeList" style="margin-bottom: 20px; max-height: 200px; overflow-y: auto;"></div>

        <h4 style="color:var(--text-muted); margin-bottom:10px; border-top:1px solid var(--glass-border); padding-top:10px;">Yeni ƒ∞≈ülem Ekle</h4>
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
            <input type="text" id="finDesc" placeholder="A√ßƒ±klama">
            <input type="number" id="finAmount" placeholder="Tutar">
            <select id="finType" style="margin:0; background-color: var(--bg-body); color: white;">
                <option value="income">Gelir (+)</option>
                <option value="expense">Gider (-)</option>
            </select>
        </div>
        <button onclick="window.addFinanceItem()" class="btn-primary" style="width:100%; margin-top:15px; justify-content:center;">Ekle</button>
        <button onclick="window.closeModal('financeModal')" style="width:100%; background:transparent; border:none; color:var(--text-muted); margin-top:10px; cursor:pointer;">Kapat</button>
    </div>
</div>

<div class="modal-bg" id="reportModal">
    <div class="modal-card">
        <h2 style="color: var(--primary); margin-bottom: 20px;"><i class="fa-solid fa-chart-pie"></i> Finansal Rapor</h2>
        <div style="overflow-x: auto;">
            <table class="finance-table">
                <thead><tr><th>Proje Adƒ±</th><th>Gelir</th><th>Gider</th><th>Net Durum</th></tr></thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
        <button onclick="window.closeModal('reportModal')" style="width:100%; margin-top:20px; background: #333; color: white; padding: 10px; border:none; border-radius:10px; cursor:pointer;">Kapat</button>
    </div>
</div>

<div class="app-container">
    <main class="main-content">
        <header class="top-bar">
            <div><h2 style="font-weight: 300; font-size:1.8rem; margin-bottom: 5px;">Proje Y√∂netimi</h2><p style="color: var(--text-muted);">Projelerim g√ºvenle y√∂netilir.</p></div>
            <button class="btn-primary" onclick="window.openProjectModal()"><i class="fa-solid fa-plus"></i> <span>Yeni Proje</span></button>
        </header>

        <section class="stats-grid">
            <div class="glass-card"><div class="stat-icon"><i class="fa-solid fa-layer-group"></i></div><div class="stat-number" id="totalCount">0</div><div class="stat-label">Toplam Proje</div></div>
            <div class="glass-card clickable-card" onclick="window.openReportModal()"><div class="stat-icon" style="color: var(--success);"><i class="fa-solid fa-wallet"></i></div><div class="stat-number" id="netFinance" style="color: var(--success);">‚Ç∫0</div><div class="stat-label">Net Kazan√ß (Detay)</div></div>
            <div class="glass-card"><div class="stat-icon" style="color: var(--warning);"><i class="fa-solid fa-bars-progress"></i></div><div class="stat-number" id="activeCount">0</div><div class="stat-label">Devam Eden</div></div>
            <div class="glass-card"><div class="stat-icon" style="color: var(--secondary);"><i class="fa-solid fa-trophy"></i></div><div class="stat-number" id="successRate">%0</div><div class="stat-label">Ba≈üarƒ± Oranƒ±</div><div style="width:100%; height:6px; background:rgba(255,255,255,0.1); margin-top:15px; border-radius:10px; overflow:hidden;"><div id="progressBar" style="width:0%; height:100%; background:linear-gradient(90deg, var(--primary), var(--secondary)); border-radius:10px; transition:1s ease-in-out;"></div></div></div>
        </section>

        <div id="loading"><i class="fa-solid fa-spinner fa-spin"></i> Veriler Y√ºkleniyor...</div>
        <h3 style="margin-bottom: 25px; font-weight: 600; font-size: 1.3rem;">Proje Listesi</h3>
        <div class="projects-wrapper" id="projectsContainer"></div>
    </main>
</div>

<script type="module">
    // 1. FIREBASE ƒ∞MPORTLARI
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // 2. CONFIG - L√úTFEN BURAYI DOLDURUN!
    const firebaseConfig = {
        apiKey: "AIzaSyDQNAvWjyw3cxp2G4-b56-hb301cSEtoYs",
        authDomain: "projetakip-b0f82.firebaseapp.com",
        projectId: "projetakip-b0f82",
        storageBucket: "projetakip-b0f82.firebasestorage.app",
        messagingSenderId: "1039037986640",
        appId: "1:1039037986640:web:0bc9e533ee41af7f741e55",
        measurementId: "G-4TFNJ03M10"
    };

    // 3. BA≈ûLATMA
    let db, projectsCollection;
    let projects = [];
    let currentEditingProjectId = null;

    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        projectsCollection = collection(db, "projects");
    } catch (error) {
        console.error("Firebase ba≈ülatƒ±lamadƒ±. Config hatasƒ± olabilir.");
    }

    // --- GLOBAL FONKSƒ∞YONLAR ---
    window.setToday = (inputId) => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById(inputId).value = today;
    };
    window.closeModal = (id) => document.getElementById(id).classList.remove('open');
    window.openProjectModal = () => {
        document.getElementById('projectModal').classList.add('open');
        document.getElementById('projectForm').reset();
        document.getElementById('todoInputs').innerHTML = '';
        window.addTodoInput();
        window.setToday('pStartDate');
    };
    window.addTodoInput = () => {
        const div = document.createElement('div');
        div.style.display = 'flex'; div.style.gap = '10px'; div.style.marginBottom = '10px';
        div.innerHTML = `
            <input type="text" class="new-todo-text" placeholder="Yapƒ±lacak i≈ü..." style="margin:0; flex:1;">
            <select class="new-todo-status" style="width:120px; margin:0; background-color: #1a1a2e;">
                <option value="Bekliyor">Bekliyor</option>
                <option value="Yapƒ±lƒ±yor">Yapƒ±lƒ±yor</option>
                <option value="Bitti">Bitti</option>
                <option value="Gerek Kalmadƒ±">Gerek Kalmadƒ±</option>
            </select>
        `;
        document.getElementById('todoInputs').appendChild(div);
    };

    // --- YENƒ∞ EKLENEN √ñZELLƒ∞K: SONRADAN TODO EKLEME ---
    window.addTodoItem = async (id) => {
        const taskName = prompt("Yeni yapƒ±lacak i≈üin adƒ± nedir?");
        if(!taskName) return;

        const p = projects.find(x => x.id === id);
        const newTodos = [...(p.todos || []), { text: taskName, status: "Bekliyor" }];

        await updateProjectInDb(id, { todos: newTodos });
    };

    // --- VERƒ∞TABANI VE ƒ∞≈û MANTIƒûI ---

    async function fetchProjects() {
        if(!db) return;
        document.getElementById('loading').style.display = 'block';
        document.getElementById('projectsContainer').innerHTML = '';
        
        try {
            const querySnapshot = await getDocs(projectsCollection);
            projects = querySnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            projects.sort((a, b) => b.createdAt - a.createdAt);
            renderProjects();
            updateStats();
        } catch (error) {
            console.error("Hata:", error);
            if(error.code === "permission-denied" || error.message.includes("api key")) {
                alert("HATA: Firebase API Key girilmemi≈ü veya veritabanƒ± kurallarƒ± (Test Mode) ayarlanmamƒ±≈ü!");
            }
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    document.getElementById('projectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (firebaseConfig.apiKey === "SENIN_API_KEY_BURAYA") {
            alert("L√ºtfen kodun en altƒ±ndaki firebaseConfig kƒ±smƒ±na kendi API bilgilerinizi girin!");
            return;
        }

        const todoItems = [];
        document.querySelectorAll('#todoInputs > div').forEach(row => {
            const txt = row.querySelector('.new-todo-text').value;
            const stat = row.querySelector('.new-todo-status').value;
            if(txt) todoItems.push({ text: txt, status: stat });
        });

        const newProjectData = {
            name: document.getElementById('pName').value,
            tech: document.getElementById('pTech').value.split(',').filter(t => t.trim()),
            startDate: document.getElementById('pStartDate').value,
            endDate: document.getElementById('pEndDate').value,
            realDate: document.getElementById('pRealDate').value || '',
            isNonProfit: document.getElementById('pNoProfit').checked,
            transactions: [],
            todos: todoItems,
            completed: false,
            createdAt: Date.now()
        };

        try {
            await addDoc(projectsCollection, newProjectData);
            window.closeModal('projectModal');
            fetchProjects();
        } catch (e) {
            console.error("Ekleme hatasƒ±: ", e);
            alert("Proje kaydedilirken hata olu≈ütu: " + e.message);
        }
    });

    window.deleteProject = async (id) => {
        if(confirm('Projeyi silmek istediƒüine emin misin?')) {
            try {
                await deleteDoc(doc(db, "projects", id));
                fetchProjects();
            } catch (e) {
                console.error("Silme hatasƒ±", e);
            }
        }
    };

    async function updateProjectInDb(id, newData) {
        try {
            const projectRef = doc(db, "projects", id);
            await updateDoc(projectRef, newData);
            fetchProjects();
        } catch (e) {
            console.error("G√ºncelleme hatasƒ±", e);
        }
    }

    window.toggleComplete = (id) => {
        const p = projects.find(x => x.id === id);
        if (!p.completed) {
            const allDone = p.todos.every(t => t.status === 'Bitti' || t.status === 'Gerek Kalmadƒ±');
            if (!allDone) { alert('‚ö†Ô∏è Projeyi tamamlamak i√ßin listedeki t√ºm maddeler bitmeli veya iptal edilmeli!'); return; }
            if (!p.realDate) p.realDate = new Date().toISOString().split('T')[0];
        }
        updateProjectInDb(id, { completed: !p.completed, realDate: p.realDate });
    };

    window.updateTodo = (id, index, newVal) => {
        const p = projects.find(x => x.id === id);
        const newTodos = [...p.todos];
        newTodos[index].status = newVal;
        updateProjectInDb(id, { todos: newTodos });
    };

    window.openFinanceModal = (id) => {
        const p = projects.find(x => x.id === id);
        if(p.isNonProfit) return;
        currentEditingProjectId = id;
        document.getElementById('finModalTitle').innerText = `üí∞ ${p.name} - Finans`;
        renderFinanceList(p);
        document.getElementById('financeModal').classList.add('open');
    };

    function renderFinanceList(project) {
        const list = document.getElementById('financeList');
        list.innerHTML = '';
        if(!project.transactions || project.transactions.length === 0) { list.innerHTML = '<div style="text-align:center; color:#666;">Hen√ºz i≈ülem yok.</div>'; return; }
        
        project.transactions.forEach((t, index) => {
            const item = document.createElement('div');
            item.style.cssText = "display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.9rem;";
            item.innerHTML = `<span>${t.desc}</span><div style="display:flex; gap:10px; align-items:center;"><span class="${t.type === 'income' ? 'text-success' : 'text-danger'}">${t.type === 'income' ? '+' : '-'}‚Ç∫${t.amount}</span><button onclick="window.deleteFinanceItem('${project.id}', ${index})" style="background:none; border:none; color:#666; cursor:pointer;"><i class="fa-solid fa-trash"></i></button></div>`;
            list.appendChild(item);
        });
    }

    window.addFinanceItem = async () => {
        const desc = document.getElementById('finDesc').value;
        const amount = Number(document.getElementById('finAmount').value);
        const type = document.getElementById('finType').value;
        if(!desc || amount <= 0) { alert('Hatalƒ± giri≈ü'); return; }
        
        const p = projects.find(x => x.id === currentEditingProjectId);
        const newTrans = [...(p.transactions || []), { desc, amount, type }];
        
        await updateProjectInDb(currentEditingProjectId, { transactions: newTrans });
        document.getElementById('finDesc').value = '';
        document.getElementById('finAmount').value = '';
    };

    window.deleteFinanceItem = async (projectId, index) => {
        const p = projects.find(x => x.id === projectId);
        const newTrans = [...p.transactions];
        newTrans.splice(index, 1);
        await updateProjectInDb(projectId, { transactions: newTrans });
    };

    window.openReportModal = () => {
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = '';
        let validProjects = projects.filter(p => !p.isNonProfit);
        if(validProjects.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ƒ∞≈ülem yok.</td></tr>'; }
        else {
            validProjects.forEach(p => {
                const trans = p.transactions || [];
                const inc = trans.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount, 0);
                const exp = trans.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount, 0);
                const net = inc - exp;
                tbody.innerHTML += `<tr><td>${p.name}</td><td class="text-success">+‚Ç∫${inc}</td><td class="text-danger">-‚Ç∫${exp}</td><td style="font-weight:bold; color:${net>=0 ? 'var(--success)' : 'var(--danger)'}">‚Ç∫${net}</td></tr>`;
            });
        }
        document.getElementById('reportModal').classList.add('open');
    };

    function getDaysDiff(d1, d2) {
        if(!d1 || !d2) return null;
        const diffTime = Math.abs(new Date(d2) - new Date(d1));
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    }

    function updateStats() {
        let total = projects.length;
        let completed = projects.filter(p => p.completed).length;
        let totalNet = 0;
        projects.forEach(p => {
            if(!p.isNonProfit && p.transactions) {
                const inc = p.transactions.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount, 0);
                const exp = p.transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount, 0);
                totalNet += (inc - exp);
            }
        });
        document.getElementById('totalCount').innerText = total;
        document.getElementById('activeCount').innerText = total - completed;
        document.getElementById('netFinance').innerHTML = totalNet >= 0 ? `+‚Ç∫${totalNet}` : `<span class="text-danger">-‚Ç∫${Math.abs(totalNet)}</span>`;
        const rate = total === 0 ? 0 : Math.round((completed/total)*100);
        document.getElementById('successRate').innerText = `%${rate}`;
        document.getElementById('progressBar').style.width = `${rate}%`;
    }

    function renderProjects() {
        const container = document.getElementById('projectsContainer');
        if (projects.length === 0) { container.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:var(--text-muted); padding:40px;">Hen√ºz proje eklenmemi≈ü.</div>`; return; }
        
        container.innerHTML = projects.map(p => {
            const trans = p.transactions || [];
            let income = 0, expense = 0;
            if(!p.isNonProfit) {
                income = trans.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount, 0);
                expense = trans.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount, 0);
            }

            let techHtml = p.tech.length ? p.tech.map(t => `<span class="tech-pill">${t}</span>`).join('') : '';
            
            let doneCount = (p.todos || []).filter(t => t.status === 'Bitti' || t.status === 'Gerek Kalmadƒ±').length;
            let totalTodos = (p.todos || []).length;
            let todoPercent = totalTodos === 0 ? 0 : Math.round((doneCount / totalTodos) * 100);

            let durationHtml = '';
            if (p.startDate && p.endDate) {
                const estimatedDays = getDaysDiff(p.startDate, p.endDate);
                if(p.completed && p.realDate) {
                    const actualDays = getDaysDiff(p.startDate, p.realDate);
                    durationHtml = `<div class="duration-info"><div class="duration-actual">üèÅ ${actualDays} G√ºnde Tamamlandƒ±</div><div class="duration-estimated">√ñng√∂r√ºlen: ${estimatedDays} G√ºn</div></div>`;
                } else {
                    durationHtml = `<div class="duration-info"><div class="duration-estimated" style="opacity:1;">üìÖ Tahmini S√ºre: ${estimatedDays} G√ºn</div></div>`;
                }
            }

            let todoHtml = (p.todos || []).map((t, i) => {
                const isDone = t.status === 'Bitti' || t.status === 'Gerek Kalmadƒ±';
                return `<div style="display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom:5px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fa-solid ${isDone ? 'fa-circle-check' : 'fa-circle'}" style="color: ${isDone ? 'var(--info)' : 'var(--text-muted)'}; font-size:0.7rem;"></i>
                        <span style="${isDone ? 'text-decoration:line-through; color:var(--text-muted);' : ''} ${t.status === 'Gerek Kalmadƒ±' ? 'font-style:italic;' : ''}">${t.text}</span>
                    </div>
                    <select onchange="window.updateTodo('${p.id}', ${i}, this.value)" style="width:auto; padding:2px 5px; margin:0; font-size:0.75rem; background:#111; border:none;">
                        <option ${t.status=='Bekliyor'?'selected':''}>Bekliyor</option>
                        <option ${t.status=='Yapƒ±lƒ±yor'?'selected':''}>Yapƒ±lƒ±yor</option>
                        <option ${t.status=='Bitti'?'selected':''}>Bitti</option>
                        <option ${t.status=='Gerek Kalmadƒ±'?'selected':''}>Gerek Kalmadƒ±</option>
                    </select>
                </div>`;
            }).join('');

            return `
            <div class="project-card">
                <div class="p-header">
                    <div><div class="p-title">${p.name}</div><div style="font-size:0.75rem; color:var(--text-muted);">${p.startDate} - ${p.completed ? p.realDate : p.endDate}</div></div>
                    <button onclick="window.toggleComplete('${p.id}')" style="border:none; background:none; cursor:pointer;"><span class="status-badge ${p.completed ? 'status-done' : 'status-active'}">${p.completed ? 'Tamamlandƒ±' : 'Devam Ediyor'}</span></button>
                </div>
                
                <div class="card-progress-container">
                    <div class="card-progress-text"><span>ƒ∞lerleme</span> <span>%${todoPercent}</span></div>
                    <div class="card-progress-bar-bg"><div class="card-progress-fill" style="width: ${todoPercent}%"></div></div>
                </div>

                <div style="display:flex; gap:8px; flex-wrap:wrap;">${techHtml}</div>
                
                <div class="p-finance ${p.isNonProfit ? 'p-finance-disabled' : ''}" onclick="window.openFinanceModal('${p.id}')">
                    ${p.isNonProfit ? '<span style="width:100%; text-align:center; font-style:italic;">Hobi Projesi</span>' : 
                        `<div style="display:flex; flex-direction:column; gap:3px;"><span style="color:var(--text-muted); font-size:0.75rem;">Gelir/Gider</span><div><span class="text-success">+‚Ç∫${income}</span> / <span class="text-danger">-‚Ç∫${expense}</span></div></div>
                        <div style="text-align:right;"><span style="color:var(--text-muted); font-size:0.75rem;">Net</span><div style="font-weight:700; color:${(income-expense)>=0?'var(--success)':'var(--danger)'}">‚Ç∫${income-expense}</div></div>`
                    }
                </div>
                
                ${durationHtml}

                <div style="background:rgba(0,0,0,0.15); padding:15px; border-radius:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <small style="color:var(--text-muted); font-weight:600;">YAPILACAKLAR</small>
                        <button onclick="window.addTodoItem('${p.id}')" style="background:none; border:none; color:var(--info); cursor:pointer; font-size:0.8rem; font-weight:bold;">+ Ekle</button>
                    </div>
                    <div style="max-height:150px; overflow-y:auto;">
                        ${p.todos && p.todos.length > 0 ? todoHtml : '<div style="text-align:center; font-size:0.8rem; color:#555;">Liste bo≈ü</div>'}
                    </div>
                </div>

                <div style="margin-top:auto; padding-top:10px; display:flex; justify-content:flex-end;"><button onclick="window.deleteProject('${p.id}')" style="color:var(--text-muted); background:none; border:none; cursor:pointer;"><i class="fa-solid fa-trash-can"></i> Sil</button></div>
            </div>`;
        }).join('');
    }

    fetchProjects();
</script>

</body>
</html>